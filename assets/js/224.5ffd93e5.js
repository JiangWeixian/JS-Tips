(window.webpackJsonp=window.webpackJsonp||[]).push([[224],{573:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"浮点数陷阱"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#浮点数陷阱"}},[t._v("#")]),t._v(" 浮点数陷阱")]),t._v(" "),a("h2",{attrs:{id:"前置知识-js中的数据存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前置知识-js中的数据存储"}},[t._v("#")]),t._v(" 前置知识 - JS中的数据存储")]),t._v(" "),a("p",[t._v("可以先看看我关于"),a("a",{attrs:{href:"https://github.com/JiangWeixian/JS-Tips/blob/master/docs/Grammar/JS-%E5%AE%9E%E7%8E%B0%E5%A4%A7%E6%95%B4%E6%95%B0%E7%9B%B8%E5%8A%A0.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("大整数"),a("OutboundLink")],1),t._v("的总结。")]),t._v(" "),a("h2",{attrs:{id:"前置知识-什么是浮点数陷阱？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前置知识-什么是浮点数陷阱？"}},[t._v("#")]),t._v(" 前置知识 - 什么是浮点数陷阱？")]),t._v(" "),a("p",[t._v("一行代码表示"),a("code",[t._v("0.1+0.2===0.3")]),t._v("会是"),a("code",[t._v("false")])]),t._v(" "),a("p",[t._v("而"),a("code",[t._v("7*0.8")]),t._v("最后结果是"),a("code",[t._v("5.6000000000000005")]),t._v("。")]),t._v(" "),a("p",[t._v("上诉两个都是非常让人感到疑惑。")]),t._v(" "),a("p",[t._v("因为不符合认知。")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("MDN")]),t._v("中"),a("code",[t._v("Number")]),t._v("有一个函数获得一个数字在存储中的真实表示：")]),t._v(" "),a("div",{staticClass:"language-JavaScript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" numObj "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"numObj.toPrecision()  is "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" numObj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toPrecision")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//输出 0.8")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"numObj.toPrecision(3) is "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" numObj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toPrecision")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//输出 0.800")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"numObj.toPrecision(2) is "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" numObj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toPrecision")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("54")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//输出 0.800000000000000044408920985006261616945266723632812500")]),t._v("\n")])])]),a("p",[t._v("可以得到一个结论，其实我们看的"),a("code",[t._v("0.8")]),t._v("可能后面带着一串 "),a("strong",[t._v("不知道来自哪里的数字，就像是上面一样")]),t._v("，只是我们看不见而已。才会出现上面的"),a("code",[t._v("bug")])]),t._v(" "),a("p",[a("strong",[t._v("当我们使用：")])]),t._v(" "),a("div",{staticClass:"language-JavaScript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.800000000000000044408920985006261616945266723632812500")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 结果就是5.6000000000000005")]),t._v("\n")])])]),a("p",[t._v("现在来到了为什么"),a("code",[t._v("0.8")]),t._v("会出现以上哪种行为？首先我么要知道")]),t._v(" "),a("blockquote",[a("p",[t._v("而JS在计算过程中总是先转换为二进制->在实现二进制相加(或者相乘)->再转换为10进制，"),a("strong",[t._v("再因为浮点数显示长度限制，只有前多少位的二进制数字才能够被转换为10进制。才有了上面不符合认知的情况")])])]),t._v(" "),a("p",[t._v("而"),a("code",[t._v("0.8")]),t._v("转化为二进制形式为"),a("code",[t._v("0.1100110011001100110011001100110011001100110011001101")]),t._v("。此时我们来手动计算一下"),a("code",[t._v("0.8")]),t._v("的转换为二进制的情况：")]),t._v(" "),a("div",{staticClass:"language-JavaScript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.6")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1....0.6")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.6")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1....0.2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 0....0.4")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 0....0.8")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.6")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1....0.6")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//可以发现，接下来就是一个无线循环1100的过程")]),t._v("\n")])])]),a("p",[a("strong",[t._v("所以如果计算存储的位数够多，"),a("code",[t._v("0.8")]),t._v("的二进制表示应该是无限循环的数字。但是我们只能够存储其中一部分，然后转换为10进制的时候，也就导致了出现0.8后面多了一串奇怪的东西")]),t._v(" 这就是为什么会出现浮点数陷阱。")]),t._v(" "),a("p",[t._v("完整解析见"),a("a",{attrs:{href:"https://github.com/camsong/blog/issues/9",target:"_blank",rel:"noopener noreferrer"}},[t._v("@camsong-浮点数陷阱"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"解决-如何得到精确的计算结果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决-如何得到精确的计算结果"}},[t._v("#")]),t._v(" 解决 - 如何得到精确的计算结果")]),t._v(" "),a("p",[t._v("有很多解决方案")]),t._v(" "),a("ol",[a("li",[t._v("像python那样使用"),a("code",[t._v("numpy")]),t._v("的库")]),t._v(" "),a("li",[t._v("如果仅仅是判断两个数字是否相等，可以通过"),a("code",[t._v("Number.EPSILON")]),t._v("属性，判断两个数字如果差值在这个范围内的话，就返回是相等。")])]),t._v(" "),a("p",[t._v("但是如果我们真的是想要一个计算结果，相对准确的那种。")]),t._v(" "),a("p",[t._v("可以参考这里的"),a("a",{attrs:{href:"http://www.css88.com/archives/7340",target:"_blank",rel:"noopener noreferrer"}},[t._v("总结"),a("OutboundLink")],1),t._v("。大致思路也就是")]),t._v(" "),a("ol",[a("li",[t._v("先变为整数(比如说乘以1000之类)，不要小数再计算")]),t._v(" "),a("li",[t._v("最后才除以1000")])])])}),[],!1,null,null,null);s.default=e.exports}}]);